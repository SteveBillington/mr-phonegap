<!DOCTYPE html>
<html>
<head>
<title>Product Details Example</title>
<script type="text/javascript" charset="utf-8" src="cordova-2.0.0.js"></script>
<script src="static/jquery-1.8.0.min.js"></script>
<script src="SQLitePlugin.js"></script>
<script src="iscroll.js"></script>  
<script src="tts.js"></script>  
<style type="text/css">
.category-text {
	width: 15%;
	
}
.max-products-text {
	width: 15%;
}
.baseURL-text {
	width: 50%;
	
}
button.normal {
  background-color: #f3f3f3;
  background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #f3f3f3), color-stop(50%, #dddddd), color-stop(50%, #d2d2d2), color-stop(100%, #dfdfdf));
  background-image: -webkit-linear-gradient(top, #f3f3f3 0%, #dddddd 50%, #d2d2d2 50%, #dfdfdf 100%);
  background-image: linear-gradient(top, #f3f3f3 0%, #dddddd 50%, #d2d2d2 50%, #dfdfdf 100%);
  border-right: 1px solid #dfdfdf;
  border-bottom: 1px solid #b4b4b4;
  border-right: 1px solid #dfdfdf;
  -webkit-border-radius: 5px;
  border-radius: 5px;
  -webkit-box-shadow: inset 0 1px 0 0 white, 0 1px 0 0 #d5d5d5, 0 -1px 2px 1px #efefef;
  box-shadow: inset 0 1px 0 0 white, 0 1px 0 0 #d5d5d5, 0 -1px 2px 1px #efefef;
  color: #666;
  display: block;
  font: bold 16px "helvetica neue", helvetica, arial, sans-serif;
  margin: 10px auto;
  padding: 7px 0;
  text-shadow: 0 1px 1px #fff;
  width:100%;
}
button.normal:hover {
    background-color: #e5e5e5;
    background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #e5e5e5), color-stop(50%, #d1d1d1), color-stop(50%, #c4c4c4), color-stop(100%, #b8b8b8));
    background-image: -webkit-linear-gradient(top, #e5e5e5 0%, #d1d1d1 50%, #c4c4c4 50%, #b8b8b8 100%);
    background-image: linear-gradient(top, #e5e5e5 0%, #d1d1d1 50%, #c4c4c4 50%, #b8b8b8 100%);
    -webkit-box-shadow: inset 0 1px 0 0 #f2f2f2, 0 1px 0 0 #c9c9c9, 0 -1px 2px 1px #e3e3e3;
    box-shadow: inset 0 1px 0 0 #f2f2f2, 0 1px 0 0 #c9c9c9, 0 -1px 2px 1px #e3e3e3; }
  button.normal:active {
    -webkit-box-shadow: inset 0 0 30px 0 #999999, 0 1px 0 0 white;
    box-shadow: inset 0 0 30px 0 #999999, 0 1px 0 0 white;
}

</style>

<!--  Move this script to its own js file.  Database access -->
<script type="text/javascript" charset="utf-8">
	var productsList = '';
	var newProductsList = '';
	function findCategoryList(callback) {
	  	var db = window.sqlitePlugin.openDatabase("Database", "1.0", "PhoneGap Demo", 200000);

	  	db.transaction(function(tx) {
	    	tx.executeSql('CREATE TABLE IF NOT EXISTS category_list (id integer primary key, category_id text, max_products integer)');
	    	tx.executeSql('CREATE TABLE IF NOT EXISTS demo_configuration (id integer primary key, base_url text)');
	  	});
	  	
		$("#baseURL").val('');
			  	
	  	db.transaction(function(tx) {
	  		tx.executeSql("select base_url from demo_configuration;", [], function(tx, res) {
				$("#baseURL").val(res.rows.item(0).base_url);
	        });
	   	});
		// Clear out rows
		for (var rowX = 1; rowX < 6; rowX++) {
			$("#categoryId" + rowX).val('');
			$("#maxProducts" + rowX).val('');
		}
	  	
	  	db.transaction(function(tx) {
	  		tx.executeSql("select category_id, max_products from category_list;", [], function(tx, res) {
	  			for (var x = 0; x < res.rows.length; x++) {
					var i = x + 1;
					$("#categoryId" + i).val(res.rows.item(x).category_id);
					$("#maxProducts" + i).val(res.rows.item(x).max_products);
	  			}
	  		  	if (callback && typeof(callback) === "function") {  
	  		        callback();  
	  		    }  else {
	  		    	console.log('callback = ' + callback);
	  		    }
	        });
	   	});
	}  
	function saveCategoryList() {
	  	var db = window.sqlitePlugin.openDatabase("Database", "1.0", "PhoneGap Demo", 200000);

	  	db.transaction(function(tx) {
	    	tx.executeSql('CREATE TABLE IF NOT EXISTS category_list (id integer primary key, category_id text, max_products integer)');
	    	tx.executeSql('CREATE TABLE IF NOT EXISTS demo_configuration (id integer primary key, base_url text)');
	    	tx.executeSql('delete from category_list');
	    	tx.executeSql('delete from demo_configuration');
	  	});
	  	
	  	for (var i = 1; i < 6; i++) {
	  		var tempCategoryId = $("#categoryId" + i).val();
	  		var tempMaxProducts = $("#maxProducts" + i).val();
			if (isNaN(tempMaxProducts) || tempMaxProducts == '') {
				tempMaxProducts = 20;
			} 
	  		if (tempCategoryId != '') {
			  	db.transaction(function(tx) {
			  		tx.executeSql("INSERT INTO category_list (category_id, max_products) VALUES (?,?)", [tempCategoryId, tempMaxProducts], function(tx, res) {
			  	    	console.log("insertId: " + res.insertId);
			  		});
	  		   	});
		  	}
	  	}
  		var tempBaseURL = $("#baseURL").val();
  		if (tempBaseURL != '') {
		  	db.transaction(function(tx) {
		  		tx.executeSql("INSERT INTO demo_configuration (base_url) VALUES (?)", [tempBaseURL], function(tx, res) {
		  	    	console.log("insertId: " + res.insertId);
		  		});
  		   	});
	  	}
	}  



</script>


<script type="text/javascript" charset="utf-8">
	var totalProductsNotAvailable = 0;	
	var saveTotalProductsNotAvailable = 0;	

	$(document).ready(function(){
	  $("#ProductList").hide();
	  $("#ProductDisplay").hide();
	  $("#CategoryList").hide();
	  $("#PhonegapVersion").hide();
    document.addEventListener("deviceready", onDeviceReady, false);
  });

  function onDeviceReady() {
	     window.plugins.tts.startup(startupTTS, fail);
		 window.onresize = function(){ checkOrientation(); }
		 checkOrientation();
	     setPhoneGapVersion();
	     var myScroll = new iScroll('ProductList');
  }
  function startupTTS(result) {
	    if (result == TTS.STARTED) {
	    }
	}

	function fail(result) {
	    alert("Error = " + result);
	    console.log("Error = " + result);
	}
  
  
  function setPhoneGapVersion() {
      var phoneGapVersion = 'PhoneGap (version '+
      device.phonegap + ')<br />' + device.platform + ' '+
      device.name + ' (version ' + device.version +   ').';
      $('#phoneGapVersion').html(phoneGapVersion);
  	  startWatch();
	  getProductList();
  }

  function getProductDisplay() {
	  $("#ProductDisplay").show();
		 checkOrientation();

	  $("#ProductList").hide();
	  $("#CategoryList").hide();
	  $("#PhonegapVersion").hide();
  }
  function getProductDetails(inProductId, inProductName, inImageURL) { 
	  var html = '<div>' + inProductId + '</div>';
      html += '<div>' + inProductName.replace("inch", "\"") + '</div>';
      $('#productDetails').html(html);
      $('#productImage').attr('src', inImageURL);
      
      getProductDisplay();
  }

  
  function getProductList() {

	  findCategoryList(function() {
			totalProductsNotAvailable = 0;	
			  $("#ProductList").show();

			  $("#ProductDisplay").hide();
			  $("#CategoryList").hide();
			  $("#PhonegapVersion").hide();

			  getProductListFromWebService(1);
		});
  }

  function getProductListFromWebService(rowNumber) {
	if (rowNumber > 5) {  
		if (totalProductsNotAvailable != saveTotalProductsNotAvailable) {
			window.plugins.tts.speak("There are . " + totalProductsNotAvailable + " items that are not available.");
			saveTotalProductsNotAvailable = totalProductsNotAvailable;
		}
		return false; 
	}
  	var searchingHtml = '<div>Searching the selected categories for items not available . . . </div>';
	var productsDisplayed = '';
	var html = '';
	var tempSearchCategory = $('#categoryId' + rowNumber).val();
	var tempCounter = $('#maxProducts' + rowNumber).val();
	if (tempSearchCategory && tempSearchCategory != '') {
		$('#divProductList' + rowNumber).html('<div><b>Category: ' + tempSearchCategory + '</b></div>' + searchingHtml);
		// Get the items in the category.
		var baseURL = $('#baseURL').val();
		$.getJSON(baseURL + '/services/category/' + tempSearchCategory + '/entities.do?entityTypes=4&sourceId=4&pageSize=' + tempCounter, function(data) { 
			if (data && data.dataset.entities.values) {
				var totalItemsToSearch = data.dataset.entities.values.length;
				if (totalItemsToSearch > tempCounter) {
					totalItemsToSearch = tempCounter;
				}
				for (var xx = 0; xx < totalItemsToSearch; xx++) {
					var value = data.dataset.entities.values[xx];					
  			  		if (html == '') {
	  			  		html = '<div style="height:1%">&nbsp;</div>';
	  			  		html += '<div style="color:blue;font-weight:bold">Category: ' + tempSearchCategory + ' - Products Not Available</div>';
	  			  		html += '<div style="height:1%">&nbsp;</div>';
	  			  		html += '<div style="color:blue;"><div style="float:left;width:25%">Product</div><div style="float:left;width:75%">Description</div></div>';
	  			  		html += '<div style="height:1%">&nbsp;</div>';
					}
	  			  	if (value.display_price == null && productsDisplayed.indexOf('*' + value.id + '*') == -1) {
	  			  		totalProductsNotAvailable++;
	  			  		var imageFileURL = value.images.main_image.file_url;
						imageFileURL = imageFileURL.replace("http://images.ocp_ws.pg.micros-retail.com", "http://184.73.30.145");
						var tempDisplayName = value.display_name;
						tempDisplayName = tempDisplayName.replace("\"", "inch");
						html += '<div><div style="float:left;width:25%"><a href="javascript:getProductDetails(' + value.id + ', \'' + tempDisplayName + '\', \'' + imageFileURL + '\');">' + value.id + '</a></div><div style="float:left;width:75%">' + value.display_name + '</div></div>';
						productsDisplayed += '*' + value.category.id + '*';
	  			  	}
				}				
				$('#divProductList' + rowNumber).html(html);
			}
			getProductListFromWebService(rowNumber + 1);
    	});
	} else {
		getProductListFromWebService(rowNumber + 1);
	}
  }  
  
  function getCategoryList() {
  		findCategoryList(function() {
  		  $("#CategoryList").show();

  		  $("#ProductList").hide();
  		  $("#ProductDisplay").hide();
  		  $("#PhonegapVersion").hide();
	  	});
  }
  function getPhonegapVersion() {
	  $("#PhonegapVersion").show();

	  $("#ProductDisplay").hide();
	  $("#ProductList").hide();
	  $("#CategoryList").hide();
  }
  
  
  // Adjust divs based on Phone Orientation
  function checkOrientation() {
	  var mql = window.matchMedia("(orientation: portrait)");
	  if (mql.matches) {
		  $('#divProductSpecs').css({"width": "100%"});
	      $('#difProductImage').css({"width": "100%"});
	  } else {
	      $('#divProductSpecs').css({"width": "50%", "float":"left"});
	      $('#difProductImage').css({"width": "50%", "float":"left"});
	  }
  }
  
  
  // Start watching the acceleration
  
  function startWatch() {
       
      var previousReading = {
          x: null,
          y: null,
          z: null
      }
       
      navigator.accelerometer.watchAcceleration(function (acceleration) {
        var changes = {},
        bound = 0.2;
        if (previousReading.x !== null) {
            changes.x = Math.abs(previousReading.x, acceleration.x);
            changes.y = Math.abs(previousReading.y, acceleration.y);
            changes.z = Math.abs(previousReading.z, acceleration.z);
        }
         
        if (changes.x > bound && changes.y > bound && changes.z > bound) {
          shaken();
        }
         
        previousReading = {
        x: acceleration.x,
        y: acceleration.y,
        z: acceleration.z
        }
         
        }, onError, { frequency: 2000 });
  }
   
  function shaken(){
      alert("Shaken");
  }
   
  // Error
  function onError() {
      alert('onError!');
  }

  function exitApplication() {
	  navigator.app.exitApp();
  }
  
</script>
</head>
<body>
  <div>
	<img style="width:80%;" src="../images/micros-ecommerce.png"/>  
  </div>
  <div id="buttons">
	<div style="float:left;width:30%">
	<Button
		onClick="javascript:getProductList();"
		class = "normal">
    		Products
    </Button>
	</div>
	<div style="float:left;width:30%">
	<Button
		onClick="javascript:getCategoryList();" 
		class = "normal">
    		Categories
    </Button>
	</div>
	<div style="float:left;width:30%">
	<Button
		onClick="javascript:getPhonegapVersion();" 
		class = "normal">
    		About
    </Button>
	</div>
	<div style="float:left;width:10%">
	<Button
		onClick="javascript:exitApplication();" 
		class = "normal">
    		X
    </Button>
	</div>
  </div>
  <div style="height:2%;">&nbsp;</div>

  <div id="PhonegapVersion">
	  <h4 id="phoneGapVersion"></h4>
  </div>
  <div id="ProductDisplay">
	  <div id="divProductSpecs">
		  <div id="productDetails"></div>
	  </div>
	  <div id="difProductImage">
		  <img id="productImage" style="height:20%;"/>
	  </div>
  </div>
  <div id="ProductList">
	  <div id="divProductList1">
	  </div>
	  <div id="divProductList2">
	  </div>
	  <div id="divProductList3">
	  </div>
	  <div id="divProductList4">
	  </div>
	  <div id="divProductList5">
	  </div>
  </div>
  <div id="CategoryList">
	  Category List
	  <br/><label>Category 1</label>&nbsp;&nbsp;<input type="text" id="categoryId1" class="category-text"/>&nbsp;&nbsp;<label>Max Products</label>&nbsp;&nbsp;<input type="text" pattern="\d*" id="maxProducts1" class="max-products-text"/>
	  <br/><label>Category 2</label>&nbsp;&nbsp;<input type="text" id="categoryId2" class="category-text"/>&nbsp;&nbsp;<label>Max Products</label>&nbsp;&nbsp;<input type="text" pattern="\d*" id="maxProducts2" class="max-products-text"/>
	  <br/><label>Category 3</label>&nbsp;&nbsp;<input type="text" id="categoryId3" class="category-text"/>&nbsp;&nbsp;<label>Max Products</label>&nbsp;&nbsp;<input type="text" pattern="\d*" id="maxProducts3" class="max-products-text"/>
	  <br/><label>Category 4</label>&nbsp;&nbsp;<input type="text" id="categoryId4" class="category-text"/>&nbsp;&nbsp;<label>Max Products</label>&nbsp;&nbsp;<input type="text" pattern="\d*" id="maxProducts4" class="max-products-text"/>
	  <br/><label>Category 5</label>&nbsp;&nbsp;<input type="text" id="categoryId5" class="category-text"/>&nbsp;&nbsp;<label>Max Products</label>&nbsp;&nbsp;<input type="text" pattern="\d*" id="maxProducts5" class="max-products-text"/>
	  <br/><label>Base URL</label>&nbsp;&nbsp;<input type="text" id="baseURL" class="baseURL-text"/>
	  <br/><button onClick="saveCategoryList();">Save Category List</button>
  </div>
</body>
</html>